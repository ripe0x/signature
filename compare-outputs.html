<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compare Outputs</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, sans-serif;
      background: #1a1a1a;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #444; }
    .seed-display {
      font-family: monospace;
      color: #888;
      font-size: 14px;
    }
    .mode-display {
      font-family: monospace;
      color: #6cf;
      font-size: 14px;
    }
    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .panel {
      background: #222;
      border-radius: 8px;
      padding: 16px;
    }
    .panel h2 {
      font-size: 14px;
      color: #888;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .output-container {
      width: 100%;
      aspect-ratio: 1200 / 1697;
      position: relative;
      overflow: hidden;
      background: #000;
    }
    .output-container canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button id="random-btn">Random Seed</button>
    <button id="prev-btn">Previous</button>
    <button id="next-btn">Next</button>
    <span class="seed-display">Seed: <span id="seed-value">0</span></span>
    <span class="mode-display">Mode: <span id="mode-value">-</span></span>
    <span class="mode-display">Chars: <span id="char-count">-</span></span>
  </div>

  <div class="comparison">
    <div class="panel">
      <h2>Canvas Output (renderToCanvas)</h2>
      <div class="output-container">
        <canvas id="canvas-output"></canvas>
      </div>
    </div>
    <div class="panel">
      <h2>Interactive Output (extractCharacterData)</h2>
      <div class="output-container">
        <canvas id="interactive-output"></canvas>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      generateAllParams,
      renderToCanvas,
      extractCharacterData,
      REFERENCE_WIDTH,
      REFERENCE_HEIGHT,
      DRAWING_MARGIN,
      CHAR_WIDTH_RATIO,
      FONT_STACK
    } from './web/fold-core.js';

    let currentSeed = Math.floor(Math.random() * 1000000);
    // Use A4 dimensions
    const WIDTH = 600;
    const HEIGHT = Math.round(600 * (REFERENCE_HEIGHT / REFERENCE_WIDTH));

    function renderCanvas(seed) {
      const params = generateAllParams(seed, REFERENCE_WIDTH, REFERENCE_HEIGHT, 0, null);

      // Call renderToCanvas directly with all params
      const result = renderToCanvas({
        folds: params.folds,
        seed: seed,
        outputWidth: WIDTH,
        outputHeight: HEIGHT,
        bgColor: params.palette.bg,
        textColor: params.palette.text,
        accentColor: params.palette.accent,
        cellWidth: params.cells.cellW,
        cellHeight: params.cells.cellH,
        renderMode: params.renderMode,
        showEmptyCells: params.showEmptyCells,
        multiColor: params.multiColor,
        levelColors: params.levelColors,
        foldStrategy: params.foldStrategy,
        paperProperties: params.paperProperties,
        showCreaseLines: params.showCreaseLines,
        analyticsMode: params.analyticsMode,
      });

      // Copy to display canvas
      const displayCanvas = document.getElementById('canvas-output');
      displayCanvas.width = result.canvas.width;
      displayCanvas.height = result.canvas.height;
      const ctx = displayCanvas.getContext('2d');
      ctx.drawImage(result.canvas, 0, 0);

      return params.renderMode;
    }

    function renderInteractive(seed) {
      const params = generateAllParams(seed, REFERENCE_WIDTH, REFERENCE_HEIGHT, 0, null);
      const state = { seed, foldCount: params.folds, params };

      const charData = extractCharacterData(state, WIDTH, HEIGHT);

      const canvas = document.getElementById('interactive-output');
      const dpr = 2;
      canvas.width = WIDTH * dpr;
      canvas.height = HEIGHT * dpr;

      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // Draw background
      ctx.fillStyle = charData.background.color;
      ctx.fillRect(0, 0, WIDTH, HEIGHT);

      // Draw background texture (same as renderToCanvas)
      const scaleX = WIDTH / REFERENCE_WIDTH;
      const scaleY = HEIGHT / REFERENCE_HEIGHT;
      const textureFontSize = 15 * scaleX;
      ctx.font = `${textureFontSize}px ${FONT_STACK}`;
      ctx.fillStyle = charData.background.textureColor;
      ctx.globalAlpha = charData.background.textureOpacity;
      const texCharWidth = textureFontSize * CHAR_WIDTH_RATIO;
      const texCharHeight = textureFontSize * 1.13;
      for (let y = 0; y < HEIGHT + texCharHeight; y += texCharHeight) {
        for (let x = 0; x < WIDTH + texCharWidth; x += texCharWidth) {
          ctx.fillText('\u2591', x, y + texCharHeight);
        }
      }
      ctx.globalAlpha = 1.0;

      // Draw characters from extractCharacterData
      ctx.textBaseline = 'top';
      for (const c of charData.characters) {
        ctx.font = `${c.fontSize}px ${FONT_STACK}`;
        ctx.fillStyle = c.color;

        const charW = c.fontSize * CHAR_WIDTH_RATIO;
        const charsPerCell = Math.max(1, Math.floor(c.width / charW));

        for (let i = 0; i < charsPerCell; i++) {
          ctx.fillText(c.char, c.x + i * charW, c.y);
        }
      }

      return params.renderMode;
    }

    function render(seed) {
      currentSeed = seed;
      document.getElementById('seed-value').textContent = seed;

      const mode = renderCanvas(seed);
      renderInteractive(seed);

      document.getElementById('mode-value').textContent = mode;
    }

    document.getElementById('random-btn').addEventListener('click', () => {
      render(Math.floor(Math.random() * 1000000));
    });

    document.getElementById('prev-btn').addEventListener('click', () => {
      render(currentSeed - 1);
    });

    document.getElementById('next-btn').addEventListener('click', () => {
      render(currentSeed + 1);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'r' || e.key === ' ') {
        render(Math.floor(Math.random() * 1000000));
      } else if (e.key === 'ArrowLeft') {
        render(currentSeed - 1);
      } else if (e.key === 'ArrowRight') {
        render(currentSeed + 1);
      }
    });

    // Initial render
    render(currentSeed);
  </script>
</body>
</html>
